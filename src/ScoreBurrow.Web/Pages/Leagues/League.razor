@page "/leagues/{LeagueId:guid}"

<PageTitle>League - @(league?.Name ?? "Unknown")</PageTitle>

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Caching.Memory
@using ScoreBurrow.Data
@using ScoreBurrow.Data.Entities
@using ScoreBurrow.Data.Enums
@using ScoreBurrow.Web.Services
@inject ScoreBurrowDbContext DbContext
@inject IMemoryCache MemoryCache
@inject NavigationManager NavigationManager
@inject ILeagueService LeagueService
@inject ILeagueStatisticsService StatisticsService
@inject AuthenticationStateProvider AuthenticationStateProvider

<h1>League @(league?.Name ?? "Unknown")</h1>

@if (league == null)
{
    if (isLoading)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="alert alert-danger" role="alert">
            League not found or you don't have permission to view it.
        </div>
    }
}
else
{
    @if (!league.IsActive)
    {
        <div class="alert alert-warning" role="alert">
            <span class="oi oi-warning me-2"></span>
            <strong>This league is archived.</strong> It is hidden from the public leagues list.
        </div>
    }

    <div class="mb-4">
        @if (!string.IsNullOrWhiteSpace(league.Description))
        {
            <p class="lead">@league.Description</p>
        }
        <div class="mb-3">
            <small class="text-muted">
                Created: @(league?.CreatedDate.ToString("MMM dd, yyyy") ?? "Unknown")
                <span class="ms-3">Members: <strong>@(topPlayers?.Count ?? 0)</strong></span>
                <span class="ms-3">Total Games: <strong>@totalGames</strong></span>
                @if (gamePages > 1)
                {
                    <span class="ms-3">Page @(currentGamePage)</span>
                }
            </small>
        </div>
        <div class="mb-3">
            <a href="/leagues" class="btn btn-outline-secondary">
                <span class="oi oi-chevron-left" aria-hidden="true"></span> Back to Leagues
            </a>
            @if (canManageLeague)
            {
                <a href="/leagues/@LeagueId/manage" class="btn btn-primary ms-2">
                    <span class="oi oi-cog me-1" aria-hidden="true"></span> Manage League
                </a>
                <a href="/leagues/@LeagueId/game/create" class="btn btn-success ms-2">
                    <span class="oi oi-plus me-1" aria-hidden="true"></span> New Game
                </a>
            }
        </div>
    </div>

    <!-- Top Players Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="mb-3">Top Players</h2>
            @if (topPlayers == null || !topPlayers.Any())
            {
                <div class="alert alert-info">
                    <em>No players found in this league.</em>
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var player in topPlayers)
                    {
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        @(!string.IsNullOrWhiteSpace(player.PlayerDisplayName) ? player.PlayerDisplayName : player.PlayerNickname)
                                        @if (player.IsUnregistered)
                                        {
                                            <span class="badge bg-warning ms-1">Unregistered</span>
                                        }
                                    </h6>
                                    <div class="mb-2">
                                        <span class="badge bg-primary">
                                            Rating: @player.Glicko2Rating.ToString("F0")
                                        </span>
                                    </div>
                                    <div class="small text-muted mb-2">
                                        Games Played: @player.GamesPlayed<br>
                                        Win Rate: @(player.WinRate.HasValue ? $"{player.WinRate.Value:F1}%" : "N/A")
                                        @if (player.GamesPlayed > 0)
                                        {
                                            <br>@("Favorite Town: ")@(player.FavoriteTownName ?? "N/A")
                                        }
                                    </div>
                                    <a href="@($"/leagues/{LeagueId}/player/{player.LeagueMembershipId}")" class="btn btn-outline-primary btn-sm">
                                        View Profile <span class="oi oi-person" aria-hidden="true"></span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Town/Hero Statistics Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="mb-3">Town & Hero Meta (Last 365 Days)</h2>
            @if (townStats == null)
            {
                <p><em>Loading statistics...</em></p>
            }
            else if (!townStats.Any())
            {
                <div class="alert alert-info">
                    <em>No statistics available. Play some games to see town and hero performance data.</em>
                </div>
            }
            else
            {
                var sortedTowns = townStats.OrderByDescending(t => t.WinRate).Take(10).ToList();

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Town</th>
                                <th>Games</th>
                                <th>Win Rate</th>
                                <th>W/L</th>
                                <th>Avg Gold</th>
                                <th>Median Gold</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (town, index) in sortedTowns.Select((t, i) => (t, i)))
                            {
                                <tr>
                                    <td>
                                        <strong>@town.TownName</strong>
                                        @if (town.ValueCategory.HasValue)
                                        {
                                            <span class="ms-1 badge @(town.ValueCategory == ScoreBurrow.Web.Models.TownValueCategory.Undervalued ? "bg-info" : "bg-danger")"
                                                  title="@(town.ValueCategory == ScoreBurrow.Web.Models.TownValueCategory.Undervalued ? "Undervalued - Good performance for the gold cost" : "Overhyped - Expensive but low win rate")">
                                                @(town.ValueCategory == ScoreBurrow.Web.Models.TownValueCategory.Undervalued ? "⭐" : "⚠️")
                                            </span>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">@town.GamesPlayed</span></td>
                                    <td>
                                        <span class="badge @GetWinRateBadgeClass(index, sortedTowns.Count)">
                                            @town.WinRate.ToString("F1")%
                                        </span>
                                    </td>
                                    <td><small>@town.Wins/@(town.GamesPlayed - town.Wins)</small></td>
                                    <td><small>@town.AvgGoldTrade</small></td>
                                    <td><small>@town.MedianGoldTrade</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" type="button"
                                                onclick="toggleTownStats(this, '@town.TownName.Replace("'", "\\'")')">
                                            Details ▼
                                        </button>
                                    </td>
                                </tr>
                                <tr class="town-details-row" style="display: none;">
                                    <td colspan="7" class="p-3 bg-light border-0">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6>Hero Performance</h6>
                                                @if (town.TopWinningHeroes.Any())
                                                {
                                                    <ul class="small list-unstyled">
                                                        @foreach (var hero in town.TopWinningHeroes.Take(3))
                                                        {
                                                            <li>
                                                                <strong>@hero.HeroName</strong>
                                                                - @hero.WinRate.ToString("F0")% WR (@hero.GamesPlayed games)
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <em>No hero data available</em>
                                                }
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Most Popular Players</h6>
                                                @if (town.TopPlayers.Any())
                                                {
                                                    <ul class="small list-unstyled">
                                                        @foreach (var player in town.TopPlayers.Take(3))
                                                        {
                                                            <li>
                                                                <strong>@(string.IsNullOrEmpty(player.PlayerDisplayName) ? player.PlayerNickname : player.PlayerDisplayName)</strong>
                                                                @if (player.IsUnregistered)
                                                                {
                                                                    <span class="badge bg-warning ms-1">Unreg.</span>
                                                                }
                                                                <br>
                                                                <small class="text-muted">@player.GamesPlayed games</small>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <em>No player data available</em>
                                                }
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Best Performers</h6>
                                                @if (town.BestPlayers.Any())
                                                {
                                                    <ul class="small list-unstyled">
                                                        @foreach (var player in town.BestPlayers.Take(3))
                                                        {
                                                            <li>
                                                                <strong>@(string.IsNullOrEmpty(player.PlayerDisplayName) ? player.PlayerNickname : player.PlayerDisplayName)</strong>
                                                                @if (player.IsUnregistered)
                                                                {
                                                                    <span class="badge bg-warning ms-1">Unreg.</span>
                                                                }
                                                                <br>
                                                                <small class="text-muted">@player.WinRate.ToString("F1")% WR (@player.GamesPlayed games)</small>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <em>No player data available</em>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (townStats.Count > 10)
                {
                    <p class="text-muted small">Showing top 10 towns by win rate. More towns may be available as more games are played.</p>
                }
            }
        </div>
    </div>

    <!-- Colour Statistics Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="mb-3">Colour Performance by Game Size (Last 365 Days)</h2>
            @if (colorStats == null)
            {
                <p><em>Loading colour statistics...</em></p>
            }
            else if (!colorStats.Any())
            {
                <div class="alert alert-info">
                    <em>No colour statistics available. Play more games to see how colours affect win rates.</em>
                </div>
            }
            else
            {
                @foreach (var gameSizeStats in colorStats.OrderBy(c => c.GameSize))
                {
                    <h4>@(gameSizeStats.GameSize)-Player Games</h4>
                    <div class="table-responsive mb-4">
                        <table class="table table-sm table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Colour</th>
                                    <th>Win Rate</th>
                                    <th>W/L</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var color in gameSizeStats.ColorPerformances.OrderBy(c => (int)c.Color))
                                {
                                    <tr>
                                        <td>
                                            <strong>@color.ColorName</strong>
                                        </td>
                                        <td>
                                            <span class="badge @GetWinRateBadgeClassByValue(color.WinRate, gameSizeStats.ColorPerformances.Select(c => c.WinRate).ToList())">
                                                @color.WinRate.ToString("F1")%
                                            </span>
                                        </td>
                                        <td><small>@color.Wins/@(color.TotalGames - color.Wins)</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
        </div>
    </div>

<script>
function toggleTownStats(button, townName) {
    const row = button.closest('tr').nextElementSibling;
    const isHidden = row.style.display === 'none';

    if (isHidden) {
        row.style.display = 'table-row';
        button.innerHTML = 'Details ▲';
    } else {
        row.style.display = 'none';
        button.innerHTML = 'Details ▼';
    }
}
</script>

    <!-- Games Section -->
    <div class="row">
        <div class="col-12">
            <h2 class="mb-3">Recent Games</h2>
            @if (games == null || !games.Any())
            {
                <div class="alert alert-info">
                    <em>No games found in this league.</em>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Map</th>
                                <th>Status</th>
                                <th>Players</th>
                                <th>Winner</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var game in games)
                            {
                                <tr>
                                    <td>@game.StartTime.ToString("MMM dd, yyyy HH:mm")</td>
                                    <td>@game.MapName</td>
                                    <td>
                                        <span class="badge @(GetStatusBadgeClass(game.Status))">
                                            @GetStatusDisplayName(game.Status)
                                        </span>
                                    </td>
                                    <td>@game.Participants?.Count participants</td>
                                    <td>
                                        @if (game.Winner != null)
                                        {
                                            @(!string.IsNullOrWhiteSpace(game.Winner.PlayerDisplayName) ?
                                                game.Winner.PlayerDisplayName :
                                                game.Winner.PlayerNickname)
                                        }
                                        else
                                        {
                                            <em>N/A</em>
                                        }
                                    </td>
                                    <td>
                                        @if (game.Status == GameStatus.InProgress && canManageLeague)
                                        {
                                            <a href="@($"/leagues/{LeagueId}/game/{game.Id}/manage")" class="btn btn-sm btn-warning me-1">
                                                <span class="oi oi-wrench" aria-hidden="true"></span> Manage
                                            </a>
                                        }
                                        <a href="@($"/leagues/{LeagueId}/game/{game.Id}")" class="btn btn-sm btn-outline-primary">
                                            View <span class="oi oi-eye" aria-hidden="true"></span>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (gamePages > 1)
                {
                    <nav aria-label="Games pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(currentGamePage == 1 ? "disabled" : "")">
                                <a class="page-link" href="/leagues/@LeagueId?gamePage=@(currentGamePage - 1)" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            @{
                                int startPage = Math.Max(1, currentGamePage - 2);
                                int endPage = Math.Min(gamePages, currentGamePage + 2);
                            }
                            @for (int i = startPage; i <= endPage; i++)
                            {
                                var pageNum = i;
                                <li class="page-item @(currentGamePage == pageNum ? "active" : "")">
                                    <a class="page-link" href="/leagues/@LeagueId?gamePage=@pageNum">@pageNum</a>
                                </li>
                            }
                            <li class="page-item @(currentGamePage == gamePages ? "disabled" : "")">
                                <a class="page-link" href="/leagues/@LeagueId?gamePage=@(currentGamePage + 1)" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid LeagueId { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public int GamePage { get; set; } = 1;

    private ScoreBurrow.Data.Entities.League? league;
    private List<TopPlayerView>? topPlayers;
    private List<GameView>? games;
    private List<ScoreBurrow.Web.Models.TownStatisticsDto>? townStats;
    private List<ScoreBurrow.Web.Models.ColorStatisticsDto>? colorStats;
    private bool isLoading = true;
    private bool canManageLeague = false;
    private string? userId;
    private int currentGamePage = 1;
    private int gamePages = 1;
    private int totalGames = 0;
    private const int GamesPerPage = 50;

    protected override async Task OnInitializedAsync()
    {
        currentGamePage = GamePage > 0 ? GamePage : 1;
        
        // Get current user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        }
        
        await LoadDataAsync();
        
        // Load statistics separately (async, don't block page load)
        if (league != null)
        {
            townStats = await StatisticsService.GetLeagueTownStatisticsAsync(LeagueId);
            colorStats = await StatisticsService.GetLeagueColorStatisticsAsync(LeagueId);
        }
        
        isLoading = false;
    }

    protected override async Task OnParametersSetAsync()
    {
        currentGamePage = GamePage > 0 ? GamePage : 1;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        // Make cache key user-specific to avoid showing guest cached data to owners
        var cacheKey = $"league_{LeagueId}_{userId ?? "anonymous"}";

        if (!MemoryCache.TryGetValue(cacheKey, out LeagueData? cachedLeagueData))
        {
            // Get league with basic info
            var leagueData = await DbContext.Leagues
                .AsNoTracking()
                .FirstOrDefaultAsync(l => l.Id == LeagueId);

            if (leagueData == null)
                return;

            // If league is archived, check if user is the owner or a member
            if (!leagueData.IsActive)
            {
                if (string.IsNullOrEmpty(userId))
                {
                    // Anonymous users can't access archived leagues
                    return;
                }

                // Allow access if user is owner or member
                var isOwnerOrMember = (leagueData.OwnerId == userId) ||
                                     await LeagueService.IsMemberAsync(userId, LeagueId);

                if (!isOwnerOrMember)
                {
                    // User is neither owner nor member, don't show archived league
                    return;
                }
            }

            league = leagueData;

            // Get top players - get memberships first
            var topMemberships = await DbContext.LeagueMemberships
                .AsNoTracking()
                .Include(m => m.Statistics)
                .ThenInclude(s => s!.FavoriteTown)
                .Where(m => m.LeagueId == LeagueId)
                .OrderByDescending(m => m.Glicko2Rating)
                .Take(10)
                .ToListAsync();

            // Build top players view
            topPlayers = new List<TopPlayerView>();
            foreach (var membership in topMemberships)
            {
                // Count games played by this player in this league
                var gamesPlayed = await DbContext.GameParticipants
                    .AsNoTracking()
                    .Where(gp => gp.LeagueMembershipId == membership.Id && gp.Game.LeagueId == LeagueId)
                    .CountAsync();

                decimal? winRate = null;
                string? favoriteTownName = null;

                if (membership.Statistics != null)
                {
                    favoriteTownName = membership.Statistics.FavoriteTown?.Name;
                    if (membership.Statistics.GamesPlayed > 0)
                    {
                        winRate = (decimal)membership.Statistics.GamesWon * 100 / membership.Statistics.GamesPlayed;
                    }
                }

                topPlayers.Add(new TopPlayerView
                {
                    LeagueMembershipId = membership.Id,
                    PlayerNickname = membership.PlayerNickname,
                    PlayerDisplayName = membership.PlayerDisplayName,
                    Glicko2Rating = membership.Glicko2Rating,
                    IsUnregistered = membership.UserId == null,
                    GamesPlayed = gamesPlayed,
                    WinRate = winRate,
                    FavoriteTownName = favoriteTownName
                });
            }

            // Get games pagination info
            totalGames = await DbContext.Games
                .AsNoTracking()
                .Where(g => g.LeagueId == LeagueId)
                .CountAsync();

            gamePages = (int)Math.Ceiling(totalGames / (double)GamesPerPage);

            if (currentGamePage > gamePages && gamePages > 0)
            {
                NavigationManager.NavigateTo($"/leagues/{LeagueId}?gamePage={gamePages}");
                return;
            }

            // Get games for current page
            var gamesData = await DbContext.Games
                .AsNoTracking()
                .Where(g => g.LeagueId == LeagueId)
                .OrderByDescending(g => g.StartTime)
                .Skip((currentGamePage - 1) * GamesPerPage)
                .Take(GamesPerPage)
                .Include(g => g.Participants)
                .Include(g => g.Winner)
                .ToListAsync();

            games = gamesData.Select(g => new GameView
            {
                Id = g.Id,
                StartTime = g.StartTime,
                MapName = g.MapName,
                Status = g.Status,
                Participants = g.Participants ?? new List<GameParticipant>(),
                Winner = g.Winner
            }).ToList();

            // Cache for 10 minutes with sliding expiration
            cachedLeagueData = new LeagueData
            {
                League = league,
                TopPlayers = topPlayers,
                Games = games
            };

            var cacheOptions = new MemoryCacheEntryOptions()
                .SetSlidingExpiration(TimeSpan.FromMinutes(10));

            MemoryCache.Set(cacheKey, cachedLeagueData, cacheOptions);
        }
        else
        {
            league = cachedLeagueData!.League;
            topPlayers = cachedLeagueData.TopPlayers;
            games = cachedLeagueData.Games;

            // Calculate total games from cached data
            totalGames = await DbContext.Games
                .AsNoTracking()
                .Where(g => g.LeagueId == LeagueId)
                .CountAsync();

            gamePages = (int)Math.Ceiling(totalGames / (double)GamesPerPage);
        }
        
        // Always recalculate canManageLeague (not cached) to ensure it's up-to-date
        if (!string.IsNullOrEmpty(userId) && league != null)
        {
            canManageLeague = await LeagueService.IsAdminOrOwnerAsync(userId, LeagueId);
        }
    }

    private string GetStatusBadgeClass(GameStatus status)
    {
        return status switch
        {
            GameStatus.Completed => "bg-success",
            GameStatus.InProgress => "bg-primary",
            GameStatus.Cancelled => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetStatusDisplayName(GameStatus status)
    {
        return status switch
        {
            GameStatus.Completed => "Completed",
            GameStatus.InProgress => "In Progress",
            GameStatus.Cancelled => "Cancelled",
            _ => "Unknown"
        };
    }

    private string GetWinRateBadgeClass(int index, int totalCount)
    {
        // Assign colors based on quartiles (relative performance)
        var percentile = (double)index / Math.Max(totalCount - 1, 1);

        if (percentile <= 0.25) return "bg-success";      // Top 25% - Green
        if (percentile <= 0.50) return "bg-info";         // 25-50% - Blue
        if (percentile <= 0.75) return "bg-warning";      // 50-75% - Yellow
        return "bg-danger";                                // Bottom 25% - Red
    }

    private string GetWinRateBadgeClassByValue(decimal winRate, List<decimal> allWinRates)
    {
        if (!allWinRates.Any()) return "bg-secondary";

        var sortedRates = allWinRates.OrderByDescending(r => r).ToList();
        var index = sortedRates.FindIndex(r => r == winRate);
        if (index == -1) return "bg-secondary";

        // Assign colors based on position (relative performance)
        var percentile = (double)index / Math.Max(sortedRates.Count - 1, 1);

        if (percentile <= 0.25) return "bg-success";      // Top 25% - Green
        if (percentile <= 0.50) return "bg-info";         // 25-50% - Blue
        if (percentile <= 0.75) return "bg-warning";      // 50-75% - Yellow
        return "bg-danger";                                // Bottom 25% - Red
    }

    private class LeagueData
    {
        public ScoreBurrow.Data.Entities.League? League { get; set; }
        public List<TopPlayerView>? TopPlayers { get; set; }
        public List<GameView>? Games { get; set; }
    }

    private class TopPlayerView
    {
        public Guid LeagueMembershipId { get; set; }
        public string PlayerNickname { get; set; } = string.Empty;
        public string? PlayerDisplayName { get; set; }
        public double Glicko2Rating { get; set; }
        public bool IsUnregistered { get; set; }
        public int GamesPlayed { get; set; }
        public decimal? WinRate { get; set; }
        public string? FavoriteTownName { get; set; }
    }

    private class GameView
    {
        public Guid Id { get; set; }
        public DateTime StartTime { get; set; }
        public string MapName { get; set; } = string.Empty;
        public GameStatus Status { get; set; }
        public ICollection<GameParticipant> Participants { get; set; } = new List<GameParticipant>();
        public LeagueMembership? Winner { get; set; }
    }
}
